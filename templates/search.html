{% extends "base.html" %}

{% block content %}
<header><h2>Search</h2></header>

<input type="search" id="search" placeholder="Search content...">
<div id="results"></div>

<script>
// Load the JSON search index generated by Zola
let searchIndex = null;
async function loadIndex() {
  if (!searchIndex) {
    const resp = await fetch("{{ get_url(path="search_index.en.json") }}");
    searchIndex = await resp.json();
  }
}

loadIndex();

const search = document.getElementById('search');
const results = document.getElementById('results');

search.addEventListener('input', async function() {
  const query = this.value.toLowerCase().trim();

  if (query.length < 2) {
    results.innerHTML = '';
    return;
  }

  if (!searchIndex) {
    results.innerHTML = '<p>Loading search index...</p>';
    await loadIndex();
  }

  const matches = searchIndex.filter(item =>
    item.title.toLowerCase().includes(query) ||
    item.body.toLowerCase().includes(query)
  ).slice(0, 10); // Limit to 10 results

  if (matches.length === 0) {
    results.innerHTML = '<p>No results found.</p>';
    return;
  }

  results.innerHTML = matches.map(item =>
    `<div style="margin-bottom: 1em;">
      <h3><a href="${item.permalink}">${item.title}</a></h3>
      <p>${(item.summary || item.body).substring(0, 150)}...</p>
    </div>`
  ).join('');
});
</script>
{% endblock content %}